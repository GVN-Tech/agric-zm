<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <meta name="description" content="Agrilovers - Connect Zambian farmers, share knowledge, access markets">
    <meta name="theme-color" content="#1e3a5f">
    <title>Agrilovers - Zambian Farmers Network</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Styles -->
    <link rel="stylesheet" href="css/styles.css">
    
    <!-- App Scripts (loaded in order) -->
    <script src="config/supabase-config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/toast.js"></script>
    <script src="js/tools.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/posts.js"></script>
    <script src="js/market.js"></script>
    <script src="js/groups.js"></script>
    <script src="js/messaging.js"></script>
    <script src="js/app.js" defer></script>
    
    <!-- Register Service Worker -->
    <script>
        (async () => {
            if (!('serviceWorker' in navigator)) return;

            const isLocalhost = location.hostname === 'localhost' || location.hostname === '127.0.0.1';

            if (isLocalhost) {
                try {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    await Promise.all(registrations.map((r) => r.unregister()));

                    if ('caches' in window) {
                        const keys = await caches.keys();
                        await Promise.all(keys.map((k) => caches.delete(k)));
                    }
                } catch (error) {
                    console.log('SW dev cleanup failed:', error);
                }
                return;
            }

            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('SW registered:', registration);
                    })
                    .catch((error) => {
                        console.log('SW registration failed:', error);
                    });
            });
        })();
    </script>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-brand" onclick="if(window.App){App.navigate('feed');}">
                üåæ Agrilovers
            </div>
            <div class="navbar-search" id="navbarSearch" style="display: none;">
                <input type="text" class="topbar-search" placeholder="Search farmers, crops, markets...">
            </div>
            <ul class="navbar-menu" id="navbarMenu" style="display: none;">
                <li class="navbar-item">
                    <a href="?view=feed" class="navbar-link" data-view="feed" onclick="if(window.App){App.navigate('feed'); return false;}" aria-label="Feed">
                        <div class="nav-icon">üè†</div>
                        <span>Feed</span>
                    </a>
                </li>
                <li class="navbar-item">
                    <a href="?view=showcase" class="navbar-link" data-view="showcase" onclick="if(window.App){App.navigate('showcase'); return false;}" aria-label="Showcase">
                        <div class="nav-icon">üåü</div>
                        <span>Tips</span>
                    </a>
                </li>
                <li class="navbar-item">
                    <a href="?view=market" class="navbar-link" data-view="market" onclick="if(window.App){App.navigate('market'); return false;}" aria-label="Market">
                        <div class="nav-icon">üí∞</div>
                        <span>Market</span>
                    </a>
                </li>
                <li class="navbar-item">
                    <a href="?view=groups" class="navbar-link" data-view="groups" onclick="if(window.App){App.navigate('groups'); return false;}" aria-label="Groups">
                        <div class="nav-icon">üë•</div>
                        <span>Groups</span>
                    </a>
                </li>
                <li class="navbar-item">
                    <a href="?view=messages" class="navbar-link" data-view="messages" onclick="if(window.App){App.navigate('messages'); return false;}" aria-label="Messages">
                        <div class="nav-icon">üí¨</div>
                        <span>Chat</span>
                    </a>
                </li>
                <li class="navbar-item">
                    <a href="?view=landing" class="navbar-link" id="accountNavBtn" onclick="if(window.App){App.handleAccountNav(event); return false;}" aria-label="Account">
                        <div class="nav-icon">üë§</div>
                        <span>Me</span>
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <div id="landingView" class="view" style="display: none;">
        <div class="landing">
            <div class="landing-hero">
                <div class="landing-hero-inner">
                    <div class="landing-badge">Farmers Network ‚Ä¢ Zambia</div>
                    <h1 class="landing-title">Grow together. Sell smarter. Learn faster.</h1>
                    <p class="landing-subtitle">
                        Agrilovers connects farmers to share advice, report real market prices, and build trusted groups across Zambia.
                    </p>
                    <div class="landing-cta">
                        <button class="btn btn-primary btn-lg" onclick="if(window.App){App.openAccountModal();}">Get started</button>
                        <button class="btn btn-outline btn-lg" onclick="document.getElementById('landingFeatures')?.scrollIntoView({behavior:'smooth'});">See how it works</button>
                    </div>
                    <div class="landing-trust">
                        <div class="landing-trust-item">üì± Mobile-first</div>
                        <div class="landing-trust-item">üì∂ Low-data friendly</div>
                        <div class="landing-trust-item">üîí Private by design</div>
                    </div>
                </div>
                <div class="landing-carousel" id="landingCarousel" aria-label="Farm photos">
                    <div class="landing-carousel-track">
                        <div class="landing-carousel-slide" data-caption="Fields, crops, and harvests across Zambia">
                            <img src="https://picsum.photos/seed/agrilovers-field/1200/800" alt="Farm field and crops" decoding="async" fetchpriority="high">
                        </div>
                        <div class="landing-carousel-slide" data-caption="Meet farmers, share advice, and learn faster">
                            <img src="https://picsum.photos/seed/agrilovers-farmer/1200/800" alt="Farmer working on the farm" loading="lazy" decoding="async">
                        </div>
                        <div class="landing-carousel-slide" data-caption="Market-ready produce and better pricing intelligence">
                            <img src="https://picsum.photos/seed/agrilovers-produce/1200/800" alt="Fresh farm produce" loading="lazy" decoding="async">
                        </div>
                        <div class="landing-carousel-slide" data-caption="Livestock insights: cattle, goats, poultry, and more">
                            <img src="https://picsum.photos/seed/agrilovers-livestock/1200/800" alt="Livestock on a farm" loading="lazy" decoding="async">
                        </div>
                        <div class="landing-carousel-slide" data-caption="A modern community built for real farms and real markets">
                            <img src="https://picsum.photos/seed/agrilovers-maize/1200/800" alt="Maize crop on a farm" loading="lazy" decoding="async">
                        </div>
                    </div>
                    <div class="landing-carousel-ui" aria-hidden="true">
                        <div class="landing-carousel-pill">
                            <div class="landing-carousel-pill-title">Agrilovers</div>
                            <div class="landing-carousel-pill-caption" id="landingCarouselCaption">Fields, crops, and harvests across Zambia</div>
                        </div>
                    </div>
                    <button class="landing-carousel-btn landing-carousel-prev" type="button" aria-label="Previous photo">‚Äπ</button>
                    <button class="landing-carousel-btn landing-carousel-next" type="button" aria-label="Next photo">‚Ä∫</button>
                    <div class="landing-carousel-dots" aria-label="Carousel navigation">
                        <button class="landing-carousel-dot" type="button" aria-label="Photo 1"></button>
                        <button class="landing-carousel-dot" type="button" aria-label="Photo 2"></button>
                        <button class="landing-carousel-dot" type="button" aria-label="Photo 3"></button>
                        <button class="landing-carousel-dot" type="button" aria-label="Photo 4"></button>
                        <button class="landing-carousel-dot" type="button" aria-label="Photo 5"></button>
                    </div>
                </div>
            </div>

            <div class="landing-section" id="landingFeatures">
                <h2 class="landing-section-title">Everything a farmer needs, in one place</h2>
                <div class="landing-features">
                    <div class="landing-feature">
                        <div class="landing-feature-icon">üÜò</div>
                        <div class="landing-feature-title">Ask for help</div>
                        <div class="landing-feature-text">Get answers from farmers near you, fast.</div>
                    </div>
                    <div class="landing-feature">
                        <div class="landing-feature-icon">üêõ</div>
                        <div class="landing-feature-title">Pest alerts</div>
                        <div class="landing-feature-text">Share outbreaks early to protect harvests.</div>
                    </div>
                    <div class="landing-feature">
                        <div class="landing-feature-icon">üí∞</div>
                        <div class="landing-feature-title">Market intelligence</div>
                        <div class="landing-feature-text">Report prices and compare across districts.</div>
                    </div>
                    <div class="landing-feature">
                        <div class="landing-feature-icon">üöö</div>
                        <div class="landing-feature-title">Buy & sell listings</div>
                        <div class="landing-feature-text">Post buying needs or selling offers in seconds.</div>
                    </div>
                    <div class="landing-feature">
                        <div class="landing-feature-icon">üë•</div>
                        <div class="landing-feature-title">Groups</div>
                        <div class="landing-feature-text">Work with cooperatives and regional teams.</div>
                    </div>
                    <div class="landing-feature">
                        <div class="landing-feature-icon">üí¨</div>
                        <div class="landing-feature-title">Messaging</div>
                        <div class="landing-feature-text">Coordinate transport, inputs, and bulk sales.</div>
                    </div>
                </div>
            </div>

            <div class="landing-footer">
                <div class="landing-footer-inner">
                    <div class="landing-footer-brand">üåæ Agrilovers</div>
                    <div class="landing-footer-text">A modern community platform built for farmers.</div>
                </div>
            </div>
        </div>
    </div>

    <div class="app-shell" id="appShell" style="display: none;">
        <aside class="sidebar-left">
            <div class="card">
                <div class="sidebar-profile">
                    <div class="sidebar-avatar">üåæ</div>
                    <div>
                        <div class="sidebar-name">Farmers Network</div>
                        <div class="post-meta">Zambia-wide community</div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Shortcuts</h3>
                </div>
                <div class="sidebar-links">
                    <button class="btn btn-ghost sidebar-link" onclick="App.navigate('feed')">üè† Feed</button>
                    <button class="btn btn-ghost sidebar-link" onclick="App.navigate('showcase')">üåü Showcase</button>
                    <button class="btn btn-ghost sidebar-link" onclick="App.navigate('market')">üí∞ Market</button>
                    <button class="btn btn-ghost sidebar-link" onclick="App.navigate('groups')">üë• Groups</button>
                    <button class="btn btn-ghost sidebar-link" onclick="App.navigate('messages')">üí¨ Messages</button>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Quick Actions</h3>
                </div>
                <div style="display: grid; gap: var(--spacing-sm);">
                    <button class="btn btn-primary" onclick="if(App.authManager.isAuthenticated()) { App.switchView('feed'); document.getElementById('postContent').focus(); } else { App.openAccountModal(); }">Create Post</button>
                    <button class="btn btn-outline" onclick="if(App.authManager && App.authManager.isAuthenticated && App.authManager.isAuthenticated()) { App.openMarketPriceForm(); } else { App.openAccountModal(); }">Report Price</button>
                    <button class="btn btn-outline" onclick="App.openCalculatorModal()">üßÆ Calculator</button>
                </div>
            </div>
        </aside>

        <main class="feed-column">
            <div id="feedView" class="view active">
            <!-- Weather Widget -->
            <div class="card weather-widget-card" id="weatherWidget">
                <div class="weather-widget-header">
                    <div>
                        <h3 class="weather-location">Lusaka</h3>
                        <div class="weather-date">Today</div>
                    </div>
                    <div class="text-right">
                        <div class="weather-temp-large">28¬∞C</div>
                        <div class="weather-condition">‚òÄÔ∏è Sunny</div>
                    </div>
                </div>
                <div class="weather-forecast">
                    <!-- Forecast items will be injected here -->
                </div>
            </div>
            <div class="stories-row" id="storiesRow">
                <div class="story story-add" id="addStoryBtn" role="button" tabindex="0" aria-label="Add Story">
                    <div class="story-image">+</div>
                    <div class="story-label">Add Story</div>
                </div>
                <div class="story" data-story-title="Maize Harvest">
                    <div class="story-image">üåΩ</div>
                    <div class="story-label">Maize Harvest</div>
                </div>
                <div class="story" data-story-title="Tomato Prices">
                    <div class="story-image">üçÖ</div>
                    <div class="story-label">Tomato Prices</div>
                </div>
                <div class="story" data-story-title="Livestock Tips">
                    <div class="story-image">üêÑ</div>
                    <div class="story-label">Livestock Tips</div>
                </div>
                <div class="story" data-story-title="Rainfall Alerts">
                    <div class="story-image">üåßÔ∏è</div>
                    <div class="story-label">Rainfall Alerts</div>
                </div>
                <div class="story" data-story-title="Pest Control">
                    <div class="story-image">üåø</div>
                    <div class="story-label">Pest Control</div>
                </div>
            </div>

            <div class="card" id="postComposer" style="display: none;">
                <div class="composer-header">
                    <div class="composer-avatar">üë§</div>
                    <button type="button" class="composer-input">What is happening on your farm?</button>
                </div>
                <form id="postForm" onsubmit="App.handlePostSubmit(event); return false;">
                    <div class="form-group">
                        <textarea 
                            id="postContent" 
                            class="form-textarea" 
                            placeholder="Share your farming knowledge, ask questions, or update the community..."
                            required
                        ></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Crop Tags (optional)</label>
                        <input 
                            type="text" 
                            id="cropTags" 
                            class="form-input" 
                            placeholder="e.g., Maize, Cassava, Poultry"
                        >
                        <small class="form-hint">Separate multiple crops with commas</small>
                    </div>
                    
                    <div class="form-group">
                        <div id="imagePreview" class="image-preview-row"></div>
                        <label class="btn btn-outline btn-file">
                            <span>üì∑ Add Photos</span>
                            <input type="file" id="postImages" multiple accept="image/*" onchange="App.handleImageSelect(event)">
                        </label>
                    </div>

                    <div class="form-group">
                        <button type="submit" class="btn btn-primary btn-full-width">
                            üì§ Share Post
                        </button>
                    </div>
                </form>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Farmer Needs Hub</h3>
                </div>
                <div class="needs-grid">
                    <button class="btn btn-outline needs-action" onclick="App.openNeedComposer('help')">üÜò Ask for Help</button>
                    <button class="btn btn-outline needs-action" onclick="App.openNeedComposer('pest')">üêõ Pest Alert</button>
                    <button class="btn btn-outline needs-action" onclick="App.openMarketForm('selling')">üöö Sell Produce</button>
                    <button class="btn btn-outline needs-action" onclick="App.openMarketForm('buying')">üß∫ Buy Inputs</button>
                    <button class="btn btn-outline needs-action" onclick="App.openMarketPriceForm()">üìä Report Prices</button>
                    <button class="btn btn-outline needs-action" onclick="App.switchView('groups')">üë• Find a Group</button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Find Farmers</h3>
                </div>
                <div class="form-group">
                    <input type="text" id="farmerSearchQuery" class="topbar-search" placeholder="Search by name, crops, livestock, province...">
                </div>
                <div class="form-group form-row">
                    <div>
                        <label class="form-label">Crop Tag</label>
                        <input type="text" id="farmerCropTag" class="form-input" placeholder="e.g., Maize">
                    </div>
                    <div>
                        <label class="form-label">Province</label>
                        <select id="farmerProvince" class="form-select">
                            <option value="">All Provinces</option>
                            <option value="Central">Central</option>
                            <option value="Copperbelt">Copperbelt</option>
                            <option value="Eastern">Eastern</option>
                            <option value="Luapula">Luapula</option>
                            <option value="Lusaka">Lusaka</option>
                            <option value="Muchinga">Muchinga</option>
                            <option value="Northern">Northern</option>
                            <option value="North-Western">North-Western</option>
                            <option value="Southern">Southern</option>
                            <option value="Western">Western</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Farmer Type</label>
                    <select id="farmerType" class="form-select">
                        <option value="">All Types</option>
                        <option value="Smallholder">Smallholder</option>
                        <option value="Commercial">Commercial</option>
                        <option value="Emerging">Emerging</option>
                        <option value="Investor">Investor</option>
                    </select>
                </div>
                <div id="farmerSearchResults" class="search-results"></div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Filter Feed</h3>
                </div>
                <div class="form-group">
                    <label class="form-label">Province</label>
                    <select id="feedProvince" class="form-select">
                        <option value="">All Provinces</option>
                        <option value="Central">Central</option>
                        <option value="Copperbelt">Copperbelt</option>
                        <option value="Eastern">Eastern</option>
                        <option value="Luapula">Luapula</option>
                        <option value="Lusaka">Lusaka</option>
                        <option value="Muchinga">Muchinga</option>
                        <option value="Northern">Northern</option>
                        <option value="North-Western">North-Western</option>
                        <option value="Southern">Southern</option>
                        <option value="Western">Western</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Crop Tag</label>
                    <input type="text" id="feedCropTag" class="form-input" placeholder="e.g., Maize">
                </div>
                <div class="form-group">
                    <label class="form-label" style="display: flex; gap: 8px; align-items: center;">
                        <input type="checkbox" id="feedPhotosOnly"> Photos only
                    </label>
                </div>
                <div style="display: flex; gap: var(--spacing-sm);">
                    <button class="btn btn-primary" onclick="App.applyFeedFilters()">Apply</button>
                    <button class="btn btn-outline" onclick="App.clearFeedFilters()">Clear</button>
                </div>
            </div>

            <!-- Posts Container -->
            <div id="postsContainer">
                <div class="spinner"></div>
            </div>
            
            <!-- Preview Mode Container (Hidden by default) -->
            <div id="previewModeContainer" style="display: none;">
                <div class="card" style="background: var(--primary-pale); border: 2px solid var(--primary-light);">
                    <h3 style="color: var(--primary-dark); margin-bottom: var(--spacing-md);">‚ö†Ô∏è Configuration Required</h3>
                    <p style="margin-bottom: var(--spacing-md);">
                        The application is not connected to the database. To enable functionality:
                    </p>
                    <ol style="margin-left: var(--spacing-lg); margin-bottom: var(--spacing-md);">
                        <li>Create a Supabase project at <a href="https://supabase.com" target="_blank">supabase.com</a></li>
                        <li>Update <code>config/supabase-config.js</code> with your project credentials</li>
                        <li>Run <code>database/schema.sql</code> and <code>database/optimization.sql</code> in the Supabase SQL Editor</li>
                    </ol>
                    <p style="margin-bottom: var(--spacing-md);">
                        <strong>See SETUP.md for detailed production setup instructions.</strong>
                    </p>
                </div>
            </div>
            </div>

        <!-- Showcase View -->
        <div id="showcaseView" class="view" style="display: none;">
            <div class="card" style="background: transparent; box-shadow: none; border: none; padding: 0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md);">
                    <h3 class="card-title">üåü Farmer Showcase</h3>
                    <button class="btn btn-primary" onclick="App.switchView('feed'); document.getElementById('postImages').click();">
                        üì∑ Share Photo
                    </button>
                </div>
                
                <div id="showcaseContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: var(--spacing-sm);">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <!-- Market View -->
        <div id="marketView" class="view" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üí∞ Market Intelligence</h3>
                </div>

                <div class="card" style="margin-bottom: var(--spacing-md);">
                    <div class="card-header">
                        <h3 class="card-title">Market Listings</h3>
                    </div>
                    <div id="marketPostForm" style="display: none;">
                        <form id="marketPostFormElement" onsubmit="App.handleMarketPostSubmit(event); return false;">
                            <div class="form-group">
                                <label class="form-label">Listing Type *</label>
                                <select id="marketListingType" class="form-select" required>
                                    <option value="">Select type...</option>
                                    <option value="selling">Selling</option>
                                    <option value="buying">Buying</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Crop or Item *</label>
                                <input type="text" id="marketListingItem" class="form-input" placeholder="e.g., Maize, Fertilizer, Chicks" required>
                            </div>
                            <div class="form-group form-row">
                                <div>
                                    <label class="form-label">Quantity *</label>
                                    <input type="number" id="marketListingQty" class="form-input" min="1" step="0.01" required>
                                </div>
                                <div>
                                    <label class="form-label">Unit *</label>
                                    <select id="marketListingUnit" class="form-select" required>
                                        <option value="">Select unit...</option>
                                        <option value="kg">Kilogram (kg)</option>
                                        <option value="bag">Bag (50kg)</option>
                                        <option value="head">Head (livestock)</option>
                                        <option value="bunch">Bunch</option>
                                        <option value="litre">Litre</option>
                                        <option value="unit">Unit</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Price per Unit (ZMW)</label>
                                <input type="number" id="marketListingPrice" class="form-input" min="0" step="0.01" placeholder="Optional">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Notes</label>
                                <textarea id="marketListingNotes" class="form-textarea" placeholder="Quality, pickup point, delivery options..."></textarea>
                            </div>
                            <div class="form-group">
                                <button type="submit" class="btn btn-primary" style="width: 100%;">üìå Post Listing</button>
                            </div>
                        </form>
                    </div>
                    <div class="market-filter-tabs">
                        <button class="btn btn-ghost btn-sm" onclick="App.setMarketPostFilter(null)">All</button>
                        <button class="btn btn-ghost btn-sm" onclick="App.setMarketPostFilter('selling')">Selling</button>
                        <button class="btn btn-ghost btn-sm" onclick="App.setMarketPostFilter('buying')">Buying</button>
                    </div>
                    <div id="marketPostsContainer">
                        <div class="spinner"></div>
                    </div>
                </div>
                
                <!-- Price Report Form -->
                <div id="priceReportForm" style="display: none;">
                    <form id="priceForm" onsubmit="App.handlePriceReport(event); return false;">
                        <div class="form-group">
                            <label class="form-label">Crop or Livestock *</label>
                            <input type="text" id="priceCrop" class="form-input" required placeholder="e.g., Maize, Tomatoes, Goats">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Price per Unit (ZMW) *</label>
                            <input type="number" id="priceAmount" class="form-input" required step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Unit *</label>
                            <select id="priceUnit" class="form-select" required>
                                <option value="">Select unit...</option>
                                <option value="kg">Kilogram (kg)</option>
                                <option value="bag">Bag (50kg)</option>
                                <option value="head">Head (livestock)</option>
                                <option value="bunch">Bunch</option>
                                <option value="litre">Litre</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Province *</label>
                            <select id="priceProvince" class="form-select" required>
                                <option value="">Select Province...</option>
                                <option value="Central">Central</option>
                                <option value="Copperbelt">Copperbelt</option>
                                <option value="Eastern">Eastern</option>
                                <option value="Luapula">Luapula</option>
                                <option value="Lusaka">Lusaka</option>
                                <option value="Muchinga">Muchinga</option>
                                <option value="Northern">Northern</option>
                                <option value="North-Western">North-Western</option>
                                <option value="Southern">Southern</option>
                                <option value="Western">Western</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">District</label>
                            <input type="text" id="priceDistrict" class="form-input">
                        </div>
                        <div class="form-group">
                            <button type="submit" class="btn btn-primary" style="width: 100%;">
                                üìä Report Price
                            </button>
                        </div>
                    </form>
                </div>

                <div style="margin-bottom: var(--spacing-lg);">
                    <button class="btn btn-outline" onclick="App.togglePriceForm()">
                        üìä Report Price
                    </button>
                </div>

                <div class="card" style="margin-bottom: var(--spacing-md);">
                    <div class="card-header">
                        <h3 class="card-title">Market Snapshot</h3>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Crop or Livestock *</label>
                        <input type="text" id="avgCrop" class="form-input" placeholder="e.g., Maize">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Province</label>
                        <select id="avgProvince" class="form-select">
                            <option value="">All Provinces</option>
                            <option value="Central">Central</option>
                            <option value="Copperbelt">Copperbelt</option>
                            <option value="Eastern">Eastern</option>
                            <option value="Luapula">Luapula</option>
                            <option value="Lusaka">Lusaka</option>
                            <option value="Muchinga">Muchinga</option>
                            <option value="Northern">Northern</option>
                            <option value="North-Western">North-Western</option>
                            <option value="Southern">Southern</option>
                            <option value="Western">Western</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">District</label>
                        <input type="text" id="avgDistrict" class="form-input">
                    </div>
                    <div style="display: flex; gap: var(--spacing-sm);">
                        <button class="btn btn-primary" onclick="App.calculateMarketAverage()">Calculate Average</button>
                        <div id="avgResult" class="post-meta" style="align-self: center;"></div>
                    </div>
                </div>

                <div class="card" style="margin-bottom: var(--spacing-md);">
                    <div class="card-header">
                        <h3 class="card-title">Filter Price Reports</h3>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Crop or Livestock</label>
                        <input type="text" id="priceFilterCrop" class="form-input" placeholder="e.g., Tomatoes">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Province</label>
                        <select id="priceFilterProvince" class="form-select">
                            <option value="">All Provinces</option>
                            <option value="Central">Central</option>
                            <option value="Copperbelt">Copperbelt</option>
                            <option value="Eastern">Eastern</option>
                            <option value="Luapula">Luapula</option>
                            <option value="Lusaka">Lusaka</option>
                            <option value="Muchinga">Muchinga</option>
                            <option value="Northern">Northern</option>
                            <option value="North-Western">North-Western</option>
                            <option value="Southern">Southern</option>
                            <option value="Western">Western</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">District</label>
                        <input type="text" id="priceFilterDistrict" class="form-input">
                    </div>
                    <div style="display: flex; gap: var(--spacing-sm);">
                        <button class="btn btn-primary" onclick="App.applyMarketFilters()">Apply</button>
                        <button class="btn btn-outline" onclick="App.clearMarketFilters()">Clear</button>
                    </div>
                </div>

                <!-- Price Reports -->
                <div id="priceReportsContainer">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <!-- Groups View -->
        <div id="groupsView" class="view" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üë• Groups & Cooperatives</h3>
                </div>
                
                <div style="margin-bottom: var(--spacing-lg);">
                    <button class="btn btn-primary" onclick="App.openCreateGroupModal()">
                        ‚ûï Create Group
                    </button>
                </div>

                <!-- Groups Grid -->
                <div id="groupsContainer" class="grid grid-cols-1 md:grid-cols-2">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <!-- Messages View -->
        <div id="messagesView" class="view" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üí¨ Messages</h3>
                </div>
                <div id="chatsContainer">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
        </main>

        <aside class="sidebar-right">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Community Tips</h3>
                </div>
                <div class="tip-list">
                    <div class="tip-item">üåßÔ∏è Share rainfall updates in your area</div>
                    <div class="tip-item">üêõ Post pest alerts with photos</div>
                    <div class="tip-item">üí¨ Ask local farmers before selling</div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Market Highlights</h3>
                </div>
                <div class="tip-list">
                    <div class="tip-item">üìà Compare prices by province</div>
                    <div class="tip-item">üìç Add district for better accuracy</div>
                    <div class="tip-item">‚úÖ Report recent sales to help others</div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Trending Crops</h3>
                </div>
                <div class="trend-list">
                    <div class="trend-item">
                        <div>
                            <div>üåΩ Maize</div>
                            <div class="trend-meta">Lusaka avg 4.2 ZMW/kg</div>
                        </div>
                        <span class="trend-pill trend-up">+6%</span>
                    </div>
                    <div class="trend-item">
                        <div>
                            <div>üçÖ Tomatoes</div>
                            <div class="trend-meta">Copperbelt avg 5.8 ZMW/kg</div>
                        </div>
                        <span class="trend-pill trend-up">+4%</span>
                    </div>
                    <div class="trend-item">
                        <div>
                            <div>ü•î Potatoes</div>
                            <div class="trend-meta">Northern avg 3.1 ZMW/kg</div>
                        </div>
                        <span class="trend-pill trend-neutral">0%</span>
                    </div>
                    <div class="trend-item">
                        <div>
                            <div>üêî Poultry</div>
                            <div class="trend-meta">Eastern avg 52 ZMW/head</div>
                        </div>
                        <span class="trend-pill trend-up">+9%</span>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Price Alerts</h3>
                </div>
                <div class="alert-list">
                    <div class="alert-item">
                        <div class="alert-title">Lusaka</div>
                        <div class="post-meta">Maize up 8% this week</div>
                    </div>
                    <div class="alert-item">
                        <div class="alert-title">Copperbelt</div>
                        <div class="post-meta">Tomatoes down 5%</div>
                    </div>
                    <div class="alert-item">
                        <div class="alert-title">Southern</div>
                        <div class="post-meta">Livestock demand rising</div>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <!-- Auth Modal -->
    <div id="authModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="authModalTitle">Login</h3>
                <button class="modal-close" onclick="App.closeModal('authModal')">&times;</button>
            </div>
            
            <div id="authAlert" style="display: none;"></div>

            <div style="display: flex; gap: var(--spacing-sm); margin-bottom: var(--spacing-md);">
                <button type="button" class="btn btn-outline btn-sm" style="flex: 1;" onclick="App.setAuthMode('password')">Email & Password</button>
                <button type="button" class="btn btn-outline btn-sm" style="flex: 1;" onclick="App.setAuthMode('otp')">OTP</button>
            </div>

            <!-- Password Login Form -->
            <form id="passwordLoginForm" style="display: none;" onsubmit="App.handlePasswordLogin(event); return false;">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="authEmail" class="form-input" placeholder="email@example.com" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" id="authPassword" class="form-input" minlength="6" required>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
                </div>
                <div class="post-meta" style="justify-content: space-between;">
                    <a href="#" onclick="App.showPasswordSignup(); return false;">Create account</a>
                    <a href="#" onclick="App.setAuthMode('otp'); return false;">Use OTP instead</a>
                </div>
            </form>

            <!-- Password Signup Form -->
            <form id="passwordSignupForm" style="display: none;" onsubmit="App.handlePasswordSignup(event); return false;">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="signupEmail" class="form-input" placeholder="email@example.com" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" id="signupPassword" class="form-input" minlength="6" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Confirm Password</label>
                    <input type="password" id="signupPasswordConfirm" class="form-input" minlength="6" required>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Create account</button>
                </div>
                <div class="post-meta" style="justify-content: space-between;">
                    <a href="#" onclick="App.showPasswordLogin(); return false;">Already have an account?</a>
                    <a href="#" onclick="App.setAuthMode('otp'); return false;">Use OTP instead</a>
                </div>
            </form>

            <!-- OTP Send Form -->
            <form id="otpSendForm" onsubmit="App.handleOTPSend(event); return false;">
                <div class="form-group">
                    <label class="form-label">Email or Phone</label>
                    <input 
                        type="text" 
                        id="authEmailOrPhone" 
                        class="form-input" 
                        placeholder="email@example.com or +260XXXXXXXXX"
                        required
                    >
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        Send OTP
                    </button>
                </div>
            </form>

            <!-- OTP Verify Form -->
            <form id="otpVerifyForm" style="display: none;" onsubmit="App.handleOTPVerify(event); return false;">
                <div class="form-group">
                    <label class="form-label">Enter OTP Code</label>
                    <input 
                        type="text" 
                        id="otpCode" 
                        class="form-input" 
                        placeholder="123456"
                        maxlength="6"
                        required
                    >
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        Verify & Login
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Profile Creation Modal -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="profileModalTitle">Complete Your Profile</h3>
                <button class="modal-close" id="profileModalClose" onclick="App.closeModal('profileModal')" style="display: none;">&times;</button>
            </div>
            <form id="profileForm" onsubmit="App.handleProfileCreate(event); return false;">
                <div class="form-group">
                    <label class="form-label">First Name *</label>
                    <input type="text" id="profileFirstName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Last Name *</label>
                    <input type="text" id="profileLastName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Phone</label>
                    <input type="tel" id="profilePhone" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Province *</label>
                    <input type="text" id="profileProvince" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">District</label>
                    <input type="text" id="profileDistrict" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Farmer Type *</label>
                    <select id="profileFarmerType" class="form-select" required>
                        <option value="">Select...</option>
                        <option value="Smallholder">Smallholder</option>
                        <option value="Commercial">Commercial</option>
                        <option value="Emerging">Emerging</option>
                        <option value="Investor">Investor</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Crops</label>
                    <input type="text" id="profileCrops" class="form-input" placeholder="e.g., Maize, Cassava">
                </div>
                <div class="form-group">
                    <label class="form-label">Livestock</label>
                    <input type="text" id="profileLivestock" class="form-input" placeholder="e.g., Cattle, Goats, Chickens">
                </div>
                <div class="form-group">
                    <label class="form-label">Farm Size (Hectares)</label>
                    <input type="number" id="profileFarmSize" class="form-input" step="0.1" min="0">
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary" id="profileSubmitButton" style="width: 100%;">
                        Save Profile
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="accountModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Account</h3>
                <button class="modal-close" onclick="App.closeModal('accountModal')">&times;</button>
            </div>
            <div class="card" style="margin-bottom: var(--spacing-md);">
                <div style="display: flex; gap: var(--spacing-md); align-items: center;">
                    <div class="comment-avatar" id="accountAvatar" style="width: 44px; height: 44px; font-size: 1rem;">üë§</div>
                    <div style="flex: 1;">
                        <div class="account-name" id="accountName">Account</div>
                        <div class="post-meta" id="accountMeta"></div>
                    </div>
                </div>
            </div>
            <div style="display: grid; gap: var(--spacing-sm);">
                <button class="btn btn-outline" onclick="App.openProfileEditModal()">Edit profile</button>
                <button class="btn btn-primary" onclick="App.handleAccountSignOut()">Sign out</button>
            </div>
        </div>
    </div>

    <div id="storyCreateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Story</h3>
                <button class="modal-close" onclick="App.closeModal('storyCreateModal')">&times;</button>
            </div>
            <form id="storyCreateForm" onsubmit="App.handleStoryCreate(event); return false;">
                <div class="form-group">
                    <label class="form-label">Photo</label>
                    <input type="file" id="storyImageInput" class="form-input" accept="image/*">
                </div>
                <div class="form-group" id="storyImagePreview" style="display: none;"></div>
                <div class="form-group">
                    <label class="form-label">Caption</label>
                    <input type="text" id="storyCaption" class="form-input" maxlength="60" placeholder="e.g., New harvest today">
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary btn-full-width">Post Story</button>
                </div>
            </form>
        </div>
    </div>

    <div id="storyViewerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="storyViewerTitle">Story</h3>
                <button class="modal-close" onclick="App.closeModal('storyViewerModal')">&times;</button>
            </div>
            <div id="storyViewerMedia"></div>
            <div class="post-meta" id="storyViewerMeta"></div>
        </div>
    </div>

    <!-- Chat Modal -->
    <div id="chatModal" class="modal">
        <div class="modal-content modal-chat">
            <div class="modal-header">
                <h3 class="modal-title" id="chatTitle">Chat</h3>
                <button class="modal-close" onclick="App.closeModal('chatModal')">&times;</button>
            </div>
            <div id="chatMessages" class="chat-messages">
                <!-- Messages will be inserted here -->
            </div>
            <form class="chat-composer" onsubmit="App.sendChatMessage(); return false;">
                <input type="text" id="chatInput" class="form-input" placeholder="Type a message...">
                <button class="btn btn-primary" type="submit">Send</button>
            </form>
        </div>
    </div>

    <div id="farmerProfileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Farmer Profile</h3>
                <button class="modal-close" onclick="App.closeModal('farmerProfileModal')">&times;</button>
            </div>
            <div id="farmerProfileContent">
                <div class="spinner"></div>
            </div>
        </div>
    </div>

    <!-- Create Group Modal -->
    <div id="createGroupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create Group</h3>
                <button class="modal-close" onclick="App.closeModal('createGroupModal')">&times;</button>
            </div>
            <form id="createGroupForm" onsubmit="App.handleCreateGroup(event); return false;">
                <div class="form-group">
                    <label class="form-label">Group Name *</label>
                    <input type="text" id="groupName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="groupDescription" class="form-textarea"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Group Type *</label>
                    <select id="groupType" class="form-select" required onchange="App.handleGroupTypeChange()">
                        <option value="">Select...</option>
                        <option value="crop">Crop-Based</option>
                        <option value="regional">Regional</option>
                        <option value="cooperative">Cooperative</option>
                        <option value="general">General</option>
                    </select>
                </div>
                <div class="form-group" id="cropTagGroup" style="display: none;">
                    <label class="form-label">Crop Tag</label>
                    <input type="text" id="groupCropTag" class="form-input" placeholder="e.g., Maize">
                </div>
                <div class="form-group" id="provinceGroup" style="display: none;">
                    <label class="form-label">Province</label>
                    <input type="text" id="groupProvince" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="groupIsPublic" checked> Public Group
                    </label>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        Create Group
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Post Detail Modal -->
    <div id="postModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">Post Details</h3>
                <button class="modal-close" onclick="App.closeModal('postModal')">&times;</button>
            </div>
            <div id="postModalContent">
                <!-- Post content will be rendered here -->
            </div>
        </div>
    </div>

    <!-- Calculator Modal -->
    <div id="calculatorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">üåæ Farm Calculator</h3>
                <button class="modal-close" onclick="App.closeModal('calculatorModal')">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label">Calculator Type</label>
                <select id="calcType" class="form-select">
                    <option value="seed">Seed Rate</option>
                    <option value="fertilizer">Fertilizer Estimate</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Crop</label>
                <select id="calcCrop" class="form-select">
                    <option value="Maize">Maize</option>
                    <option value="Soybeans">Soybeans</option>
                    <option value="Wheat">Wheat</option>
                    <option value="Groundnuts">Groundnuts</option>
                    <option value="Sunflower">Sunflower</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Farm Size (Hectares)</label>
                <input type="number" id="calcArea" class="form-input" placeholder="e.g. 1.5" min="0.1" step="0.1">
            </div>
            <div class="form-group">
                <button class="btn btn-primary" style="width: 100%;" onclick="App.calculateTools()">Calculate</button>
            </div>
            <div id="calcResult" style="margin-top: var(--spacing-md);"></div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="modal" style="display: flex;">
        <div class="spinner"></div>
    </div>
</body>
</html>

